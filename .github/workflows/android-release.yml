name: Build & Publish Release APK

on:
  # Run manually from the Actions tab
  workflow_dispatch:

  # Run automatically when you push a version tag like v1.0.0
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    # Needed so the workflow can create a GitHub Release and upload assets
    permissions:
      contents: write

    steps:
      # 1) Checkout source
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Set up Java (Android builds typically require JDK 17)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 3) Cache Gradle for faster builds
      - name: Gradle cache
        uses: gradle/actions/setup-gradle@v3

      # 4) Recreate keystore file from GitHub Secret (never commit the keystore)
      # IMPORTANT: We write it into app/ because your Gradle signing config uses file("keystore.jks")
      # relative to the app module directory.
      - name: Decode keystore into app/
        shell: bash
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/keystore.jks
          ls -la app | sed -n '1,200p'

      # 5) Allow running gradlew
      - name: Grant execute permission for Gradle
        run: chmod +x ./gradlew

      # 6) Build signed release APK
      - name: Build Release APK
        env:
          KEYSTORE_FILE: keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew :app:assembleRelease

      # 7) Upload as an Actions artifact (useful for debugging even if Release upload fails)
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: app/build/outputs/apk/release/*.apk

      # 8) Publish: Attach APK to the GitHub Release for this tag (public download)
      # This uses the tag that triggered the workflow (e.g., v1.0.0).
      - name: Upload APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: app/build/outputs/apk/release/*.apk
